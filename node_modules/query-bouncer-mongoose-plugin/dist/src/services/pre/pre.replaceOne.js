"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bouncerIsActivated_1 = __importDefault(require("../bouncerIsActivated"));
const removeAuthorizerOptions_1 = __importDefault(require("../removeAuthorizerOptions"));
const extractCookieOrJWTAndReturnHeader_1 = __importDefault(require("../extractCookieOrJWTAndReturnHeader"));
const preReplaceOne = async (schema, config) => {
    schema.pre('replaceOne', async function () {
        var _a;
        if ((0, bouncerIsActivated_1.default)(this.options)) {
            const axios = config.axios;
            const self = this;
            const collection = self._collection.collectionName;
            const right = 'update';
            const query = self._conditions;
            const payload = self._update;
            delete payload._id;
            try {
                const headers = (0, extractCookieOrJWTAndReturnHeader_1.default)(this.options, config);
                (0, removeAuthorizerOptions_1.default)(this);
                const newQuery = (await axios.put(`/${collection}/${right}`, { payload, query }, { headers })).data.query;
                this.setQuery(newQuery);
            }
            catch (err) {
                if (((_a = err.response) === null || _a === void 0 ? void 0 : _a.code) === 403)
                    throw 'preUpdate: User does not have Permission to Update';
                throw err;
            }
        }
    });
};
exports.default = preReplaceOne;
//# sourceMappingURL=pre.replaceOne.js.map