"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const bouncerIsActivated_1 = __importDefault(require("../../bouncerIsActivated"));
const removeAuthorizerOptions_1 = __importDefault(require("../../removeAuthorizerOptions"));
const extractCookieOrJWTAndReturnHeader_1 = __importDefault(require("../../extractCookieOrJWTAndReturnHeader"));
const class_OperationOptions_1 = __importDefault(require("../../../classes/class.OperationOptions"));
const preSaveX = async (schema, config, operation) => {
    schema.pre(operation, async function () {
        var _a, _b;
        const self = this;
        const options = new class_OperationOptions_1.default(self.$__.saveOptions);
        if ((0, bouncerIsActivated_1.default)(options)) {
            const axios = config.axios;
            const collection = self.collection.collectionName;
            const right = 'create';
            const payload = self.toObject();
            delete payload._id;
            delete payload.__v;
            try {
                const headers = (0, extractCookieOrJWTAndReturnHeader_1.default)(options, config);
                (0, removeAuthorizerOptions_1.default)(self);
                (await axios.put(`/${collection}/${right}`, { payload }, { headers }));
            }
            catch (error) {
                const err = error;
                if (((_a = err.response) === null || _a === void 0 ? void 0 : _a.status) === 403 || ((_b = err.response) === null || _b === void 0 ? void 0 : _b.code) === 403)
                    throw new Error('pre.SaveX: User does not have Permission to Create');
                throw err;
            }
        }
    });
};
exports.default = preSaveX;
//# sourceMappingURL=pre.saveX.js.map